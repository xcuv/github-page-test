<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>è¯„è®ºé¡µé¢</title>
        <style>
            .comment-container {
                max-width: 800px;
                margin: 20px auto;
                padding: 20px;
                font-family: 'Microsoft YaHei', sans-serif;
            }
            .comment-list {
                margin-top: 20px;
            }
            .comment-item {
                background: #f5f5f5;
                padding: 15px;
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .comment-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
            }
            .comment-author {
                font-weight: bold;
                color: #333;
            }
            .comment-time {
                color: #999;
                font-size: 0.9em;
            }
            .comment-content {
                color: #666;
                line-height: 1.6;
            }
            .loading {
                text-align: center;
                color: #666;
                padding: 20px;
            }
        </style>
    </head>
    <body>
        <div class="comment-container">
            <h2>è¯„è®ºåˆ—è¡¨</h2>
            <div class="comment-form">
                <h3>å‘è¡¨è¯„è®º</h3>
                <div style="margin-bottom: 15px">
                    <input
                        type="text"
                        id="authorInput"
                        placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°"
                        style="
                            width: 200px;
                            padding: 8px;
                            margin-bottom: 10px;
                            display: block;
                        "
                    />
                    <textarea
                        id="commentInput"
                        placeholder="è¯·è¾“å…¥è¯„è®ºå†…å®¹"
                        style="
                            width: 100%;
                            height: 100px;
                            padding: 8px;
                            margin-bottom: 10px;
                        "
                    ></textarea>
                    <button
                        onclick="submitComment()"
                        style="
                            padding: 8px 20px;
                            background: #4caf50;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        "
                    >
                        æäº¤è¯„è®º
                    </button>
                </div>
            </div>
            <div id="commentList" class="comment-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <script>
            // è·å–è¯„è®ºåˆ—è¡¨
            function fetchComments() {
                fetch(
                    'https://kvtest.660027.xyz/805910d0-f97d-4274-81d5-e995f197c368/remoteStorage?key=gh-comments'
                )
                    .then((response) => response.json())
                    .then((data) => {
                        console.log("ğŸš€ ~ .then ~ data:", data)
                        displayComments(data?.value || []);
                    })
                    .catch((error) => {
                        console.error('è·å–è¯„è®ºå¤±è´¥:', error);
                        document.getElementById('commentList').innerHTML =
                            '<p>åŠ è½½è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
                    });
            }

            // æäº¤è¯„è®º
            function submitComment() {
                const author =
                    document.getElementById('authorInput').value.trim() ||
                    'åŒ¿åç”¨æˆ·';
                const content =
                    document.getElementById('commentInput').value.trim() ||
                    'æµ‹è¯•è¯„è®º';

                // if (!author) {
                //     alert('è¯·è¾“å…¥æ˜µç§°');
                //     return;
                // }
                // if (!content) {
                //     alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                //     return;
                // }

                fetch(
                    'https://kvtest.660027.xyz/805910d0-f97d-4274-81d5-e995f197c368/remoteStorage',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            key: 'gh-comments',
                            value: [
                                {
                                    author,
                                    content,
                                    time: new Date().toISOString(),
                                },
                            ],
                        }),
                    }
                )
                    .then((response) => response.json())
                    .then(() => ({ok:true}))
                    // .then((existingComments) => {
                    //     const comments = existingComments || [];
                    //     // æ·»åŠ æ–°è¯„è®º
                    //     const newComment = {
                    //         author: author,
                    //         content: content,
                    //         time: new Date().toISOString(),
                    //     };
                    //     comments.push(newComment);

                    //     // ä¿å­˜æ›´æ–°åçš„è¯„è®º
                    //     return fetch(
                    //         'https://kvtest.660027.xyz/805910d0-f97d-4274-81d5-e995f197c368/remoteStorage',
                    //         {
                    //             method: 'POST',
                    //             headers: {
                    //                 'Content-Type': 'application/json',
                    //             },
                    //             body: JSON.stringify({
                    //                 key: 'gh-comments',
                    //                 value: comments,
                    //             }),
                    //         }
                    //     );
                    // })
                    .then((response) => {
                        if (response.ok) {
                            // æ¸…ç©ºè¾“å…¥æ¡†
                            document.getElementById('authorInput').value = '';
                            document.getElementById('commentInput').value = '';
                            // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
                            fetchComments();
                        } else {
                            throw new Error('æäº¤å¤±è´¥');
                        }
                    })
                    .catch((error) => {
                        console.error('æäº¤è¯„è®ºå¤±è´¥:', error);
                        alert('æäº¤è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    });
            }

            // æ˜¾ç¤ºè¯„è®º
            function displayComments(comments) {
                const commentList = document.getElementById('commentList');
                if (!comments || comments.length === 0) {
                    commentList.innerHTML = '<p>æš‚æ— è¯„è®º</p>';
                    return;
                }

                const commentsHtml = comments
                    .map(
                        (comment) => `
                <div class="comment-item">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-time">${formatDate(
                            comment.time
                        )}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                </div>
            `
                    )
                    .join('');

                commentList.innerHTML = commentsHtml;
            }

            // æ ¼å¼åŒ–æ—¥æœŸ
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }

            // é¡µé¢åŠ è½½å®Œæˆåè·å–è¯„è®º
            window.addEventListener('load', fetchComments);
        </script>
    </body>
</html>
